<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>globecurrency.org - AI Assistant</title>
    <!-- markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
    <!-- dompurify -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    <!-- prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-solidity.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <!-- Load Markdown parser -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
    <link rel="manifest" href="img/site.webmanifest">
    <link rel="mask-icon" href="img/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="Globe - The Future of Finance">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@globe_currency">
    <meta name="twitter:title" content="The Future of Finance">
    <meta name="twitter:description" content="globecurrency.org - The Future of Finance">
    <meta name="twitter:creator" content="@particlproject">
    <meta name="twitter:image" content="">
    <meta property="og:title" content="globecurrency.org - The Future of Finance">
    <meta property="og:type" content="Article">
    <meta property="og:url" content="https://globecurrency.org">
    <meta property="og:image" content="">
    <meta property="og:description" content="Globe - The Future of Finance">
    <meta property="og:site_name" content="Globe - The Future of Finance">
    <meta property="fb:admins" content="">
    <link rel="stylesheet" media="all" href="css/app.min.css">
    <script>
      var viewportmeta = document.querySelector('meta[name="viewport"]');
      if (viewportmeta) {
        if (screen.width < 375) {
          var newScale = screen.width / 375;
          viewportmeta.content = 'width=375, minimum-scale=' + newScale + ', maximum-scale=1.0, user-scalable=no, initial-scale=' + newScale + '';
        } else {
          viewportmeta.content = 'width=device-width, maximum-scale=1.0, initial-scale=1.0';
        }
      }
    </script>
  </head>
  <body>
    <script>
      console.log(localStorage.getItem('darkMode'));
      if (localStorage.getItem('darkMode') === "on") {
        document.body.classList.add("dark");
        document.addEventListener("DOMContentLoaded", function() {
          document.querySelector('.js-theme input').checked = true;
        });
      }
    </script>
    <!-- outer-->
    <div class="outer">
      <!-- header-->
      <header class="header js-header">
        <div class="header__center center"><a class="header__logo" href="https://globecurrency.org"><img class="some-icon" src="img/logo-dark.png" alt="Particl.io"><img class="some-icon-dark" src="img/logo-dark.png" alt="Particl.io"></a>
          <div class="header__wrap js-header-wrap">
            <nav class="header__nav"><a class="header__link active" href="marketplace">Marketplace</a><a class="header__link" href="coin">Coin</a><a class="header__link" target="_blank" href="https://basicswapdex.com">Dex</a><a class="header__link" href="about">About</a><a class="header__link" href="https://particl.news" target="_blank">Blog</a></nav>
            <div class="header__group">
              <div class="header__contacts">
                <div class="header__element">
                  <div class="header__subtitle"></div>
                  <div class="header__text"></div>
                </div>
              </div>
              <div class="header__socials"><a class="header__social" href="https://twitter.com/globe_currency" target="_blank" title="twitter">
                  <svg class="icon icon-twitter">
                    <use xlink:href="#icon-twitter"></use>
                  </svg></a><a class="header__social" href="https://discord.me/globecurrency" target="_blank" title="Discord">
                  <svg class="icon icon-discord">
                    <use xlink:href="#icon-discord"></use>
                  </svg></a><a class="header__social" href="https://www.reddit.com/r/globecurrency/" target="_blank" title="Reddit">
                  <svg class="icon icon-reddit">
                    <use xlink:href="#icon-reddit"></use>
                  </svg></a><a class="header__social" href="https://github.com/globeproject" target="_blank" title="Github">
                  <svg class="icon icon-github">
                    <use xlink:href="#icon-github"></use>
                  </svg></a></div><a class="button button-stroke button-small header__button" href="downloads">Install
                <svg class="icon icon-download">
                  <use xlink:href="#icon-download"></use>
                </svg></a>
            </div>
          </div><a class="button button-stroke button-small header__button" href="downloads">Install
            <svg class="icon icon-download">
              <use xlink:href="#icon-download"></use>
            </svg></a>
          <button class="header__burger js-header-burger"></button>
        </div>
      </header>

      <body>
        <div class="outer">
          <!-- AI Chat Section -->
          <div class="ai-chat-container center">
            <h1 class="h2">Globe AI Assistant</h1>
            <p>Ask our AI assistant anything about Globe, smart contracts, staking, privacy, and more.</p>
            <div class="ai-chat-log" id="chatLog"></div>
            <div class="ai-chat-input">
              <input type="text" id="userInput" placeholder="Type your question here..." />
              <button id="send-button">Send</button>
            </div>
          </div>
          <!-- Footer can go here if needed -->
        </div>
      
        <script>
          const chatLog = document.getElementById('chatLog');
          const userInput = document.getElementById('userInput');
          const sendButton = document.getElementById('send-button');
          
          // Add a stop button
          const stopButton = document.createElement('button');
          stopButton.innerText = 'Stop';
          stopButton.id = 'stop-button';
          stopButton.style.display = 'none'; // Hidden by default
          document.querySelector('.ai-chat-input').appendChild(stopButton);
          
          const md = window.markdownit({ linkify: true, breaks: true });
          let typingInterval = null; // For cancelling typing
          
          sendButton.addEventListener('click', async () => {
            const message = userInput.value.trim();
            if (!message) return;
        
            // Show user message
            const userMessageElement = document.createElement('div');
            userMessageElement.className = 'message user-message';
            userMessageElement.textContent = `You: ${message}`;
            chatLog.appendChild(userMessageElement);
        
            // Clear input
            userInput.value = '';
            
            // Send message to backend
            try {
              const response = await fetch('https://chatgpt-proxy.globecurrency25.workers.dev', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
              });
        
              const data = await response.json();
              
              // Render AI response with typing effect
              const aiMessageElement = document.createElement('div');
              aiMessageElement.className = 'message ai-message';
              chatLog.appendChild(aiMessageElement);
        
              const rawHtml = md.render(data.reply); // Markdown â†’ HTML
              const cleanHtml = DOMPurify.sanitize(rawHtml); // Sanitize
              typeHtmlGradually(aiMessageElement, cleanHtml);
        
              // Auto-scroll
              chatLog.scrollTop = chatLog.scrollHeight;
            } catch (error) {
              const errorElement = document.createElement('div');
              errorElement.className = 'message ai-message';
              errorElement.textContent = `Error: ${error.message}`;
              chatLog.appendChild(errorElement);
            }
          });
        
          // Allow pressing Enter to send
          userInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
              sendButton.click();
            }
          });
        
          // Typing function
          function typeHtmlWordByWord(container, html) {
    container.innerHTML = '';
    stopButton.style.display = 'inline-block';
    
    // Create a temporary DOM to work with
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;

    const nodes = Array.from(tempDiv.childNodes);
    let nodeIndex = 0;
    let words = [];
    let wordIndex = 0;
    
    typingInterval = setInterval(() => {
      if (nodeIndex >= nodes.length) {
        clearInterval(typingInterval);
        typingInterval = null;
        Prism.highlightAllUnder(container); // Syntax highlight after done
        stopButton.style.display = 'none';
        return;
      }

      // If starting a new node
      if (words.length === 0 && nodes[nodeIndex]) {
        const currentNode = nodes[nodeIndex];
        if (currentNode.nodeType === Node.TEXT_NODE) {
          words = currentNode.textContent.split(' ');
          container.appendChild(document.createTextNode('')); // placeholder
        } else if (currentNode.nodeType === Node.ELEMENT_NODE) {
          const clone = currentNode.cloneNode(false); // shallow clone (just tag, no children)
          container.appendChild(clone);
          words = currentNode.textContent.split(' ');
        }
      }

      // Typing words
      if (words.length > 0) {
        const lastElement = container.lastChild;
        lastElement.textContent += (lastElement.textContent ? ' ' : '') + words[wordIndex];
        wordIndex++;

        if (wordIndex >= words.length) {
          nodeIndex++;
          words = [];
          wordIndex = 0;
        }
      }

      chatLog.scrollTop = chatLog.scrollHeight;
    }, 100); // 100ms per word (adjust speed here)
  }
        
          // Stop typing
          stopButton.addEventListener('click', () => {
            if (typingInterval) {
              clearInterval(typingInterval);
              typingInterval = null;
            }
            const cursor = document.querySelector('.blinking-cursor');
            if (cursor) cursor.remove();
            stopButton.style.display = 'none';
          });
        </script>
        
      </body>
      </html>